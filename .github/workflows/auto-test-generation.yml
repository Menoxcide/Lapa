name: Auto Test Generation

on:
  push:
    branches: [main, v1.0-extract]
    paths:
      - 'src/**/*.ts'
      - '!src/**/*.test.ts'
      - '!src/**/*.spec.ts'
      - '!src/__tests__/**'
  pull_request:
    branches: [main, v1.0-extract]
    paths:
      - 'src/**/*.ts'
      - '!src/**/*.test.ts'
      - '!src/**/*.spec.ts'
      - '!src/__tests__/**'

jobs:
  generate-tests:
    name: Generate Tests for New Modules
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Install tsx
        run: npm install -g tsx
        
      - name: Detect new/modified TypeScript files
        id: detect-files
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.ts$' | grep -v '\.d\.ts$' | grep -v '\.test\.ts$' | grep -v '\.spec\.ts$' | grep -v '__tests__' | grep '^src/')
          else
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.ts$' | grep -v '\.d\.ts$' | grep -v '\.test\.ts$' | grep -v '\.spec\.ts$' | grep -v '__tests__' | grep '^src/')
          fi
          
          if [ -z "$FILES" ]; then
            echo "files=[]" >> $GITHUB_OUTPUT
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_files=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate test files
        if: steps.detect-files.outputs.has_files == 'true'
        run: |
          FILES="${{ steps.detect-files.outputs.files }}"
          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "Generating test for: $file"
              npm run test:generate -- "$file" || true
            fi
          done
          
      - name: Check if test files were generated
        if: steps.detect-files.outputs.has_files == 'true'
        id: check-tests
        run: |
          FILES="${{ steps.detect-files.outputs.files }}"
          GENERATED_TESTS=()
          for file in $FILES; do
            test_file="src/__tests__/${file#src/}"
            test_file="${test_file%.ts}.test.ts"
            if [ -f "$test_file" ]; then
              GENERATED_TESTS+=("$test_file")
            fi
          done
          
          if [ ${#GENERATED_TESTS[@]} -gt 0 ]; then
            echo "generated_tests<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' "${GENERATED_TESTS[@]}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_generated=true" >> $GITHUB_OUTPUT
          else
            echo "has_generated=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Improve test metrics
        if: steps.detect-files.outputs.has_files == 'true'
        run: |
          npm run test:improve || true
          
      - name: Run tests
        if: steps.check-tests.outputs.has_generated == 'true'
        run: |
          npm test || true
          
      - name: Create PR with generated tests
        if: steps.check-tests.outputs.has_generated == 'true' && github.event_name == 'push'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'test: auto-generate tests for new modules'
          title: 'Auto-generated tests for new modules'
          body: |
            ## Auto-Generated Tests
            
            This PR contains automatically generated test files for new/modified modules.
            
            ### Generated Test Files:
            ${{ steps.check-tests.outputs.generated_tests }}
            
            ### Test Metrics:
            - Mock Usage: 90%+
            - Async Coverage: 95%+
            - Error Coverage: 100%
            - Integration Coverage: 100%
            
            Please review and ensure all tests pass before merging.
          branch: auto-test-generation
          delete-branch: true

